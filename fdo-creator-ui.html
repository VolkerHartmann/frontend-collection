<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typed PID Maker UI</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor@0.9.3/deps/opt/popper/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/underscore/underscore-umd-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
            integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="js/semantic-ui/semantic.min.js"/>
    <script src="js/ajv/ajv.min.js"></script>
    <script src="//unpkg.com/json-form-custom-element"></script>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor@0.9.3/deps/opt/fontawesome/css/all.min.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor@0.9.3/deps/opt/bootstrap/css/bootstrap.min.css">
    <!--link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor@0.9.3/deps/opt/tabulator/tabulator_bootstrap4.min.css"-->
    <link rel="stylesheet" href="./css/semantic.min.css">

    <script src="./js/apply-config.js"></script>

    <script src="./js/editor/dependencies/jsonform/jsonform.js"></script>
    <script src="./js/editor/lib/js/metadataeditor.js"></script>
    <script src="./definitions/fdo-maker/hkip.js"></script>
    <script src="./js/FDO.js"></script>
    <script src="./js/FDOStore.js"></script>
    <script src="./definitions/fdo-maker/recordUIDefinitionCreate.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.6.1/dist/d3.min.js"></script>
    <link rel="stylesheet" href="./css/styles.css"/>
    <style>
        svg {
            flex-basis: 100%;
            min-width: 200px;
        }

        .links line {
            stroke: #aaa;
        }

        .nodes circle {
            pointer-events: all;
        }

        .modal {
            height: auto;
        }

        .marker path {
            stroke: #666;
            fill: #888;
            pointer-events: all;
        }

        .marker text {
            stroke: #000;
        }

        .highlight {
            background: lightgrey;
        }

        input.firstSelection + label {
            color: darkgreen !important;
        }

        input.secondSelection + label {
            color: darkred !important;
        }
    </style>

</head>
<body class="ui">
<json-form
        schema='{
"type": "object",
"properties": {
"payment": {
"type": "object",
"ui": {
"expandable": true
},
"title": "Payment",
"properties": {
"person": {
"type": "object",
"title": "Person",
"properties": {
"title": {
"type": "string",
"title": "Title",
"enum": [
0: "mr",
1: "ms",
2: "mrs",
3: "miss"
]
},
"firstName": {
"type": "string",
"title": "First name"
},
"middleName": {
"type": "string",
"title": "Middle name"
},
"lastName": {
"type": "string",
"title": "Last name"
}
}
},
"card": {
"type": "object",
"title": "Card",
"properties": {
"type": {
"type": "string",
"title": "Card type",
"enum": [
0: "debit",
1: "credit"
]
},
"holderType": {
"type": "string",
"title": "Holder type",
"enum": [
0: "personal",
1: "corporate"
]
},
"brand": {
"type": "string",
"title": "Brand",
"enum": [
0: "visa",
1: "mastercard",
2: "amex",
3: "discover"
]
},
"expirationDate": {
"type": "string",
"title": "Expiration date",
"format": "YYYY-MM"
},
"name": {
"type": "string",
"title": "Name"
},
"pan": {
"type": "string",
"title": "Card Number (PAN)"
},
"cvv": {
"type": "string",
"title": "CVV",
"maxLength": 4,
"minLength": 3
}
}
},
"address": {
"type": "object",
"title": "Address",
"properties": {
"line1": {
"type": "string",
"title": "Address line 1"
},
"postcode": {
"type": "string",
"title": "Postcode"
},
"countryCode": {
"type": "string",
"title": "Country code",
"const": "gb"
}
}
}
}
},
"account": {
"type": "object",
"ui": {
"expandable": true
},
"title": "Account",
"properties": {
"email": {
"type": "string",
"title": "Email"
},
"password": {
"type": "string",
"title": "Password"
},
"passwordSpecification": {
"type": "object",
"title": "Password specification",
"properties": {
"length": {
"type": "string",
"title": "Length",
"default": 12
},
"numbers": {
"type": "integer",
"title": "Numbers",
"default": 1
},
"upper": {
"type": "integer",
"title": "Upper",
"default": 1
},
"lower": {
"type": "integer",
"title": "Lower",
"default": 1
},
"special": {
"type": "integer",
"title": "Special",
"default": 1
},
"specialCharacters": {
"item": {
"type": "string",
"maxLength": 1,
"minLength": 1
},
"type": "array",
"title": "Special characters list",
"default": [
0: "#",
1: "$",
2: "%"
]
}
}
},
"isExisting": {
"type": "boolean",
"title": "Is existing",
"default": false
},
"phone": {
"type": "string",
"title": "Phone",
"properties": {
"countryCode": {
"type": "string",
"title": "Country code",
"const": "gb"
},
"number": {
"type": "string",
"title": "Number"
}
}
}
}
},
"passengers": {
"type": "object",
"ui": {
"expandable": true
},
"title": "Passengers",
"properties": {
"minItems": {
"min": 0,
"type": "integer",
"title": "Min items"
},
"maxItems": {
"min": 0,
"type": "integer",
"title": "Max items"
},
"items": {
"items": {
"type": "object",
"title": "Flight passenger",
"properties": {
"person": {
"type": "object",
"properties": {
"title": {
"type": "string",
"title": "Title",
"enum": [
0: "mr",
1: "ms",
2: "mrs",
3: "miss"
]
},
"firstName": {
"type": "string",
"title": "First name"
},
"middleName": {
"type": "string",
"title": "Middle name"
},
"lastName": {
"type": "string",
"title": "Last name"
}
}
},
"dateOfBirth": {
"title": "Random date config",
"oneOf": [
0: {
"type": "object",
"required": [
0: "static"
],
"properties": {
"static": {
"type": "string"
}
},
"additionalProperties": false
},
1: {
"type": "object",
"required": [
0: "age"
],
"properties": {
"age": {
"type": "integer"
}
},
"additionalProperties": false
},
2: {
"type": "integer"
}
]
},
"addAdditionalLuggage": {
"type": "object",
"title": "Random integer configuration",
"properties": {
"min": {
"type": "integer",
"title": "Min"
},
"max": {
"type": "integer",
"title": "Max"
}
}
},
"document": {
"type": "object",
"title": "Identity Document",
"properties": {
"type": {
"title": "Type",
"enum": [
0: "passport"
]
},
"number": {
"type": "string",
"title": "Number"
},
"issueDate": {
"type": "string",
"title": "Issue date",
"format": "date"
},
"expirationDate": {
"type": "string",
"title": "Expiration date",
"format": "date"
},
"issueCountryCode": {
"type": "string",
"title": "Country code"
}
}
}
}
},
"type": "array"
}
}
},
"outboundMonthYear": {
"title": "Outbound month year",
"oneOf": [
0: {
"type": "object",
"required": [
0: "static"
],
"properties": {
"static": {
"type": "string"
}
},
"additionalProperties": false
},
1: {
"type": "object",
"required": [
0: "age"
],
"properties": {
"age": {
"type": "integer"
}
},
"additionalProperties": false
},
2: {
"type": "integer"
}
]
},
"inboundMonthYear": {
"title": "Inbound month year",
"oneOf": [
0: {
"type": "object",
"required": [
0: "static"
],
"properties": {
"static": {
"type": "string"
}
},
"additionalProperties": false
},
1: {
"type": "object",
"required": [
0: "age"
],
"properties": {
"age": {
"type": "integer"
}
},
"additionalProperties": false
},
2: {
"type": "integer"
}
]
}
}
}', value='{
"payment": {
"person": {
},
"card": {
},
"address": {
}
},
"account": {
"passwordSpecification": {
"numbers": 1,
"upper": 1,
"lower": 1,
"special": 1,
"specialCharacters": [
0: "#",
1: "$",
2: "%"
]
},
"isExisting": false,
"phone": {
}
},
"passengers": {
}
}'
></json-form>

<h1 class="ui block header">
    <img id="app-logo" src="./images/typed-pid-maker-logo.svg" class="ui image">
    <div id="app-title" class="content">
        {app-title}
        <div id="app-subtitle" class="sub header">{app-subtitle}</div>
    </div>
    <div id="login_button" class="ui animated right floated button" tabindex="0">
        <div id="login_button_text" class="visible content">Login</div>
        <div class="hidden content">
            <i id="login_icon" class="sign-in icon"></i>
        </div>
    </div>
</h1>

<div class="ui container">
    <div id="service-url-input" class="sixteen wide column">
        <div class="two wide column">
            <div class="ui label">
                Typed PID Maker URL
            </div>
        </div>

        <div class="fourteen wide column">
            <div class="ui fluid icon input">
                <input id="endpoint" type="text" placeholder="http://localhost:8090/" value="http://localhost:8090/">
                <button class="ui vertical animated button" tabindex="0" onclick="setUrl()">
                    <div class="hidden content">Reload</div>
                    <div class="visible content">
                        <i class="fa-solid fa-arrows-rotate"></i>
                    </div>
                </button>
                <script>
                    function setUrl() {
                        let url = document.getElementById("endpoint").value;
                        document.getElementById("known-pids").setAttribute("base-url", url);
                    }
                </script>
            </div>
        </div>
    </div>

    <div class="ui segment">
        <form id="record-form"></form>
    </div>

    <div class="ui grid">
        <div class="ten wide column">
            <div class="ui segment">
                <svg id="tree" style="height:500px;width:100%"/>
            </div>
        </div>
        <script>
            let firstSelection = undefined;
            let secondSelection = undefined;

            /**Change the selection of FDO(s).
             * This function will handle persistence of selection, style changing, and validation of selection.
             */
            function selectFdo() {
                //remove all selection markers
                $("#fdo_list").find('input[inputType="fdo"]').each(function () {
                    $(this).removeClass("firstSelection");
                    $(this).removeClass("secondSelection");
                });

                //disable link selection for now, enable FDO selection, disable action buttons
                $("input[inputType='link']").attr("disabled", true);
                $("input[inputType='fdo']").attr("disabled", false);
                $("#unlink_button").addClass("disabled");
                $("#link_button").addClass("disabled");

                //get list of selected FDOs
                let selectedFdos = $("#fdo_list").find('input[inputType="fdo"]:checked').length;

                switch (selectedFdos) {
                    case 0: {
                        //do nothing, show no popup, allow select FDO and Link
                        $("input[inputType='link']").attr("disabled", false);
                        $("#link_button").removeAttr("data-content");
                        break;
                    }
                    case 1: {
                        //set first selection, show message asking for second selection
                        $("#fdo_list").find('input[inputType="fdo"]:checked').each(function () {
                            $(this).addClass("firstSelection");
                            firstSelection = $(this).attr("name");
                        });
                        $("#link_button").attr("data-content", "Please select another FDO to link to.");
                        break;
                    }
                    case 2: {
                        //set second selection, enable link button, remove message
                        $("#fdo_list").find('input[inputType="fdo"]:checked').each(function () {
                            if ($(this).attr("name") === firstSelection) {
                                //mark first selection
                                $(this).addClass("firstSelection");
                            } else {
                                //mark second selection
                                secondSelection = $(this).attr("name");
                                $(this).addClass("secondSelection");
                            }
                            $("#link_button").removeClass("disabled");
                            $("#link_button").removeAttr("data-content");
                        });
                        break;
                    }
                    default: {
                        //set message to allow only two selections
                        $("#link_button").attr("data-content", "Only two selected FDOs are allowed.");
                    }

                }

                //show popup (only happens in case a message is set)
                $('#link_button').popup({
                    on: 'mouseover',
                    variation: 'mini',
                    boundary: $('body')
                }).popup("toggle");
            }

            /**Link selection callback.
             * This function will handle enable/disable of buttons and checkboxed depending on the selection.
             */
            function selectLink() {
                $("input[inputType='link']").attr("disabled", false);
                $("#link_button").addClass("disabled");

                if ($("#fdo_list").find('input[inputType="link"]:checked').length > 0) {
                    //at least one link is selected
                    $("input[inputType='fdo']").attr("disabled", true);
                    $("#unlink_button").removeClass("disabled");
                } else {
                    $("input[inputType='fdo']").attr("disabled", false);
                    $("#unlink_button").addClass("disabled");
                }
            }

        </script>
        <div class="six wide column">
            <div class="ui scrolling segment" style="height:525px;max-height:525px">
                <div class="mini ui labeled icon button disabled" id="link_button" data-variation="mini">
                    <i class="linkify icon"></i>
                    Link
                </div>
                <div class="mini ui labeled icon button disabled" id="unlink_button">
                    <i class="unlink icon"></i>
                    Remove Link(s)
                </div>
                <div id="fdo_list" class="ui celled list">
                </div>
            </div>
        </div>

        <div class="ui tiny modal" id="link_modal">
            <div class="header">Select Relation Type</div>
            <div class="content">
                <div class="ui label" style="width:100%" id="link_source_label">
                    <i class="sign out alternate icon"></i>Source:
                </div>
                <br/>
                <select id="relation_type" class="ui dropdown" style="width:100%">
                    <option value="21.T11148/4fe7cde52629b61e3b82">isMetadataOf</option>
                    <option value="21.T11148/d0773859091aeb451528">hasMetadata</option>
                    <option value="21.T11148/c6e4c19f294ee6f41b1e">wasDerivedFrom</option>
                    <option value="21.T11148/2a1cad55473b20407c78">wasRevisionOf</option>
                    <option value="21.T11148/a753134738da82809fc1">hadPrimarySource</option>
                    <option value="21.T11148/beaeecebec408908de35">wasQuotedFrom</option>
                    <option value="21.T11148/432132bdbd946b2baf2b">alternateOf</option>
                    <option value="21.T11148/ab53242825e85a0a7f76">specializationOf</option>
                    <option value="21.T11148/c085f1292d7d4a338d96">wasGeneratedBy</option>
                    <option value="21.T11148/af11e18f83466642c47d">provenanceGraph</option>
                </select>
                <br/>
                <div class="ui label" style="width:100%" id="link_target_label">
                    <i class="sign in alternate icon"></i>Target:
                </div>

            </div>
            <div class="actions">
                <div class="ui negative button">Cancel</div>
                <div class="ui positive button" id="do_create_link_button">OK</div>
            </div>
        </div>

    </div>
</div>


<script type="module">
    let data = {
        "nodes": [
            {
                "id": "21.T11148/b3eb8a2b2a94bf5a73e7",
                "customName": "O1",
                "type": "10.123/001",
                "props": {
                    "kernelInformationProfile": "21.T11148/863d938d632b53d62d52",
                    "21.T11148/397d831aa3a9d18eb52c": "2022-06-06T00:00:00+00:00"
                }
            },
            {
                "id": "21.T11148/b3eb8a2b2a94bf5a73e8",
                "customName": "O2",
                "type": "10.123/001123123123",
                "props": {
                    "kernelInformationProfile": "21.T11148/863d938d632b53d62d52",
                    "21.T11148/397d831aa3a9d18eb52c": "2022-06-06T00:00:00+00:00"
                }
            },
            {
                "id": "21.T11148/b3eb8a2b2a94bf5a73e9",
                "customName": "O3",
                "type": "10.123/002",
                "props": {
                    "kernelInformationProfile": "21.T11148/863d938d632b53d62d52",
                    "21.T11148/397d831aa3a9d18eb52c": "2022-06-06T00:00:00+00:00"
                }
            },
            {
                "id": "21.T11148/b3eb8a2b2a94bf5a73e0",
                "customName": "O4",
                "type": "10.123/003",
                "props": {
                    "kernelInformationProfile": "21.T11148/863d938d632b53d62d52",
                    "21.T11148/397d831aa3a9d18eb52c": "2022-06-06T00:00:00+00:00"
                }
            },
            {
                "id": "21.T11148/b3eb8a2b2a94bf5a73e1",
                "customName": "O5",
                "type": "10.123/004",
                "props": {
                    "kernelInformationProfile": "21.T11148/863d938d632b53d62d52",
                    "21.T11148/397d831aa3a9d18eb52c": "2022-06-06T00:00:00+00:00"
                }
            }
        ],
        "links": [
            {
                source: "21.T11148/b3eb8a2b2a94bf5a73e7",
                target: "21.T11148/b3eb8a2b2a94bf5a73e1",
                relationType: "isMetadata"
            },
            {
                source: "21.T11148/b3eb8a2b2a94bf5a73e7",
                target: "21.T11148/b3eb8a2b2a94bf5a73e8",
                relationType: "isMetadata"
            },
            {
                source: "21.T11148/b3eb8a2b2a94bf5a73e9",
                target: "21.T11148/b3eb8a2b2a94bf5a73e0",
                relationType: "hasMetadata"
            }
        ]
    }

    let fdo1 = new FDO("Object1", "10.1234/1234123123")
    fdo1.addProperty("type", "testType");
    fdo1.addProperty("profile", "testProfile");
    fdo1.addProperty("location", "testLocation2");
    fdo1.addProperty("hasMetadata", "10.1234/456123123");

    let fdo2 = new FDO("Object2", "10.1234/456123123")
    fdo2.addProperty("type", "testType");
    fdo2.addProperty("profile", "testProfile");
    fdo2.addProperty("location", "testLocation2");
    fdo2.addProperty("isMetadataFor", "10.1234/1234123123");


    let fdoStore = new FDOStore();

    fdoStore.addFdo(fdo1);
    fdoStore.addFdo(fdo2);

    import {ajaxBaseUrl, keycloak, tags, showServiceUrl, appDescription} from './js/fdo-maker.settings.js';

    import {known_types} from './definitions/fdo-maker/known-types.js';
    import {transformUserInput} from './js/typed-pid-maker-utils.js';
    // import {chart, setData, update} from './js/graph.js';
    import {chart, render} from './code.js';

    applyConfig(ajaxBaseUrl, keycloak, tags, showServiceUrl, appDescription)

    let connectFrom = undefined;
    let connectTo = undefined;

    installEventHandlers();

    loadForm();

    chart(fdoStore);

    function installEventHandlers() {
        $("#create_link").click(() => {
            createLink();
        });

        $("#link_button").click(() => {
            openLinkFDODialog();
        });

        $("#do_create_link_button").click(() => {
            doCreateLink();
        });

    }

    function openLinkFDODialog() {
        //check if FDOs are already connected
        let existingLinks = fdoStore.getLinkedFDOs(firstSelection);
        let existing = existingLinks.find((element) => element.pid === secondSelection);
        if (existing) {
            $("#link_button").attr("data-content", "The selected FDOs are already connected as " + existing.relationType);
            $("#link_button").attr("data-variation", "red");

            $('#link_button').popup({
                on: 'mouseover',
                variation: 'mini',
                boundary: $('body')
            }).popup("toggle");
            $("#link_button").removeAttr("data-variation");
            return;
        }

        //FDOs not connected, continue with dialog
        $("#link_source_label").html("<i class=\"sign out alternate icon\"></i> Source: " + firstSelection);
        $("#link_target_label").html("<i class=\"sign in alternate icon\"></i> Target: " + secondSelection);

        $('.ui.tiny.modal').modal('show')
    }

    function doCreateLink() {
        let type = $("#relation_type").val();
        let first = $(".firstSelection").attr("name");
        let second = $(".secondSelection").attr("name");
        let source = fdoStore.getFdo(first);
        console.log(source);
        source.addProperty(type, second);
        console.log(source);
        fdoStore.addFdo(source);
        console.log(first + " - " + type + " --" + second);
        buildFdoList();
        render();
    }

    function buildFdoList() {
        let element = $("#fdo_list");
        element.empty();
        let pids = fdoStore.getPids();

        for (let pid of pids) {
            let fdo = fdoStore.getFdo(pid);
            let div = document.createElement('div');
            div.setAttribute("class", "item");
            div.innerHTML = "<div class='ui checkbox'>\n" +
                "<input type='checkbox' onchange='selectFdo()' name=" + pid + " inputType='fdo'>\n" +
                "<label name='" + pid + "'>" + fdo.getCustomName() + "(" + pid + ")</label>\n" +
                "</div>\n";

            let linkedFdos = fdoStore.getLinkedFDOs(pid);
            if (linkedFdos.length > 0) {
                let listDiv = document.createElement('div');
                listDiv.setAttribute("class", "list");

                for (let i = 0; i < linkedFdos.length; i++) {
                    let div = document.createElement('div');
                    div.setAttribute("class", "item");
                    div.innerHTML = "<div class='ui checkbox'>\n" +
                        "<input type='checkbox' onchange='selectLink()' name=" + linkedFdos[i].pid + " inputType='link'>\n" +
                        "<label name='" + linkedFdos[i].pid + "'>" + fdoStore.getFdo(linkedFdos[i].pid).getCustomName() + "(" + linkedFdos[i].pid + ") " + linkedFdos[i].relationType + "</label>\n" +
                        "</div>\n";
                    listDiv.append(div);
                }
                div.append(listDiv);
            }

            element.append(div);
            $(document).ready(function () {
                $("#fdo_list").find("label[name=\'" + pid + "\']").each(() => {
                    $(this).on('mouseover', 'label', (e) => {
                        highlight(e.target.getAttribute("name"));
                    });
                    $(this).on('mouseleave', 'label', (e) => {
                        unhighlight(e.target.getAttribute("name"));
                    });
                });
            });
        }
    }

    /**Highlight a label with a certain PID.
     * @param pid The PID to highlight.
     */
    function highlight(pid) {
        $("label[name=\'" + pid + "\']").addClass("highlight");
    }

    /**Unhighlight a label with a certain PID.
     * @param pid The PID to unhighlight.
     */
    function unhighlight(pid) {
        $("label[name=\'" + pid + "\']").removeClass("highlight");
    }

    function createLink() {
        if (connectFrom && connectTo) {
            let relationType = $("#relation_type").val();
            //let link = {source: connectFrom.id, target: connectTo.id, relationType: relationType};
            // addLink(connectFrom.id, connectTo.id, relationType)
            //data.links.push(link);
            // setData(getData());
            let source = fdoStore.getFdo(connectFrom.id);
            source.addProperty(relationType, connectTo.id);
            fdoStore.addFdo(source);
            connectFrom = undefined;
            connectTo = undefined;
            render();
        }
    }

    function loadForm() {
        //set type names selection
        model['properties']['digitalObjectType'].enum = known_types.map(a => a.label);

        //create form (mapping service map go here later)
        let options = {
            operation: "CREATE",
            dataModel: model,
            uiForm: uiDefinitionCreate,
            //resource: rowColumnvalue
        };
        $('#record-form').empty();
        $('#record-form').metadataeditorForm(options, function onSubmitValid(output) {
            //console.log(output);
            let f = new FDO().fromJson(output, known_types);
            // console.log(f);
            //let node = f.toNode()
            // console.log(JSON.stringify(node));
            fdoStore.addFdo(f);//addFdo(node);
            buildFdoList();
            render();
            //update();
            //post to TPIDM
        });
    }
</script>


</body>
</html>
